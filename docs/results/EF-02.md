# EF-02: resolveMarket Edge Function

**Status:** Complete
**Source:** `/supabase/functions/resolveMarket/index.ts`

---

## Overview

Admin-only Edge Function that resolves an open market by evaluating its resolution rule against external data sources. Updates market status, stores resolution evidence, and awards reputation points to correct predictors.

---

## Request Flow

1. **Method Validation** - Only POST allowed (405 otherwise)
2. **Authentication** - Extract Bearer token from Authorization header
3. **Admin Verification** - Decode JWT and verify `role === "admin"`
4. **Payload Validation** - Parse JSON body, validate `market_id` present
5. **Market Fetch** - Load market with resolution rule (joined)
6. **Status Check** - Verify market status is `open`
7. **Rule Validation** - Ensure resolution rule exists
8. **Verification Source Check** - If `verification_required`, ensure URL exists
9. **Data Fetch** - Query X API for mention count (or use mock data)
10. **Outcome Evaluation** - Compare mention count against `min_mentions` threshold
11. **Market Update** - Set status to `resolved`, store outcome and evidence
12. **Reputation Award** - Call `award_reputation_points` RPC function

---

## Admin Verification

The function extracts the JWT role claim using `getRoleFromJwt()`:

```typescript
const role = getRoleFromJwt(token);
if (role !== "admin") {
  return jsonResponse(403, { error: "admin_required" });
}
```

Only users with `role: "admin"` in their JWT claims can resolve markets.

---

## Resolution Logic

1. Load the market's `resolution_rules` record
2. Extract `min_mentions` from `rule_json` (default: 100)
3. Query X API: `GET /2/tweets/search/recent?query="topic_text"`
4. Extract `meta.result_count` from response
5. Outcome: `mention_count >= min_mentions`

If X API is unavailable (no bearer token or API error), mock data is used (`mention_count = 120`).

---

## Reputation Awarding

After resolution, the function calls:

```typescript
await serviceClient.rpc("award_reputation_points", {
  p_market_id: market.id,
  p_outcome: outcome
});
```

This awards reputation points to users who predicted correctly. No tokens are refunded or awarded - only reputation.

---

## Response Codes

| Code | Error Key | Description |
|------|-----------|-------------|
| 200 | - | Success, returns `market_id`, `resolved_outcome`, `mocked` |
| 400 | `invalid_json` | Request body is not valid JSON |
| 400 | `missing_market_id` | `market_id` not provided in payload |
| 400 | `missing_resolution_rule` | Market has no linked resolution rule |
| 400 | `missing_verification_source` | `verification_required` but no URL |
| 401 | `missing_auth` | No Bearer token in Authorization header |
| 403 | `admin_required` | JWT role is not `admin` |
| 404 | `market_not_found` | Market ID does not exist |
| 405 | `method_not_allowed` | Request method is not POST |
| 409 | `market_not_open` | Market status is not `open` |
| 500 | `market_update_failed` | Failed to update market record |
| 500 | `reputation_award_failed` | Failed to award reputation points |

---

## Resolution Evidence

Stored in `markets.resolution_evidence` as JSON:

```json
{
  "source": "x",
  "rule": { "min_mentions": 100 },
  "mention_count": 150,
  "mocked": false,
  "verification_source_url": "https://example.com/source"
}
```

---

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `SUPABASE_URL` | Yes | Supabase project URL |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes | Service role key (for DB operations) |
| `X_BEARER_TOKEN` | No | X API bearer token (mock data used if absent) |
