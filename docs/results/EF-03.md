# EF-03: ingestMarketsFromX Edge Function

**Status:** Complete
**Source:** `/supabase/functions/ingestMarketsFromX/index.ts`

---

## Overview

Edge Function designed for Supabase Cron that ingests trending topics from X API, applies strict safety filters, and creates markets for verified public figure events. Operates without user authentication context.

---

## Request Flow

1. **Method Validation** - Only POST allowed (405 otherwise)
2. **Fetch Trends** - Query X API for trending topics (or use mock data)
3. **Safety Filtering** - Apply keyword and topic filters
4. **Public Figure Filtering** - Only allow allowlisted public figures
5. **Verification Resolution** - Match topics to external verification sources
6. **Rule Lookup/Creation** - Get or create `x_mentions_threshold` rule
7. **Market Generation** - Build market records from verified candidates
8. **Upsert** - Insert new markets or skip existing (by `source_topic_id`)

---

## Safety Filters

The function applies multiple layers of filtering designed to reject >90% of candidates:

### 1. Unsafe Keywords (Rejected)
```typescript
["bet", "casino", "gambling", "wager", "odds"]
```

### 2. Disallowed Public Figure Topics (Rejected)
```typescript
[
  "pregnancy", "pregnant", "embarazo",
  "sexual", "sexo", "health", "salud",
  "illness", "hospital", "allegedly",
  "rumor", "rumour", "dicen que",
  "people say", "tal vez", "quizá", "quizas"
]
```

### 3. Emoji-Only Topics (Rejected)
Topics containing only emojis and whitespace are filtered out.

### 4. Public Figure Allowlist (Required)
Only topics mentioning allowlisted public figures pass:
```typescript
["carlos rivera", "sofia reyes"]
```

### 5. Verification Source Match (Required)
Topic must match a pattern with known verification source:

| Pattern | Verification URL |
|---------|------------------|
| `cuenta.*suspendid\|account.*suspend` | X Rules & Policies |
| `comunicado\|statement\|apolog` | Reuters World |
| `demanda\|lawsuit\|arrest\|convic` | Justice.gov News |

---

## Cron Compatibility

This function is designed to run via Supabase Cron with **no user authentication context**:

- No JWT required or validated
- Uses service role key internally for database operations
- Performs non-destructive upserts only (creates new, skips existing)
- Returns counts for observability

See [docs/inconsistencies.md](../inconsistencies.md) for the design decision rationale.

---

## Upsert Behavior

Markets are upserted using `source_topic_id` as the conflict key:

```typescript
await serviceClient
  .from("markets")
  .upsert(records, { onConflict: "source_topic_id" })
  .select("id");
```

This ensures:
- New trends create new markets
- Existing trends (by source ID) are not duplicated
- Safe for repeated cron invocations

---

## Response Codes

| Code | Error Key | Description |
|------|-----------|-------------|
| 200 | - | Success, returns `inserted` count and `mocked` flag |
| 405 | `method_not_allowed` | Request method is not POST |
| 500 | `rule_seed_failed` | Failed to create resolution rule |
| 500 | `market_insert_failed` | Failed to insert/upsert markets |

---

## Mock Data

When `X_BEARER_TOKEN` is not set, the function uses mock trends:

```typescript
[
  { id: "mock-1", name: "Carlos Rivera anuncia concierto" },
  { id: "mock-2", name: "Sofia Reyes: suspensión de cuenta oficial" }
]
```

The `mocked: true` flag in the response indicates mock data was used.

---

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `SUPABASE_URL` | Yes | Supabase project URL |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes | Service role key (for DB operations) |
| `X_BEARER_TOKEN` | No | X API bearer token (mock data used if absent) |

---

## Legal Safety Statement

> "Markets involving public figures are limited strictly to already-public, verifiable events. The platform does not publish or incentivize rumors or private personal speculation."

This is enforced through:
1. Strict allowlist of public figures
2. Rejection of speculative/rumor keywords
3. Requirement for external verification source
4. Binary questions derived from verifiable facts
