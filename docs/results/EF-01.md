# EF-01: placePrediction Edge Function

**Status:** Complete
**Source:** `/supabase/functions/placePrediction/index.ts`

---

## Overview

Edge Function that allows authenticated users to place predictions on open markets. Handles JWT verification, market validation, idempotency, Vudy API integration, and atomic database operations.

---

## Request Flow

1. **Method Validation** - Only POST allowed (405 otherwise)
2. **Authentication** - Extract Bearer token from Authorization header
3. **Session Verification** - Validate JWT via Supabase Auth client
4. **Payload Validation** - Parse JSON body, validate required fields
5. **Market Validation** - Verify market exists and status is `open`
6. **Idempotency Key Generation** - Generate deterministic hash
7. **Vudy API Call** - POST to `/consume` endpoint with idempotency key
8. **Database Transaction** - Call `place_prediction_tx` RPC function
9. **Response** - Return prediction ID and idempotency key

---

## Idempotency Key Formula

```
sha256(user_id + ":" + market_id + ":" + action_type)
```

Where `action_type` is always `"predict"`.

This ensures:
- Same user + same market = same key
- Duplicate requests are safely handled by Vudy API
- Retries won't double-consume tokens

---

## Response Codes

| Code | Error Key | Description |
|------|-----------|-------------|
| 200 | - | Success, returns `prediction_id` and `idempotency_key` |
| 400 | `invalid_json` | Request body is not valid JSON |
| 400 | `missing_fields` | Missing `market_id`, `choice`, or `amount` |
| 400 | `invalid_choice` | Choice must be `"yes"` or `"no"` |
| 400 | `invalid_amount` | Amount must be positive |
| 401 | `missing_auth` | No Bearer token in Authorization header |
| 401 | `invalid_session` | JWT validation failed |
| 404 | `market_not_found` | Market ID does not exist |
| 405 | `method_not_allowed` | Request method is not POST |
| 409 | `market_closed` | Market status is not `open` |
| 500 | `prediction_insert_failed` | Database transaction failed |
| 502 | `vudy_consume_failed` | Vudy API returned non-2xx |
| 502 | `vudy_missing_tx_id` | Vudy response missing `vudy_tx_id` |

---

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `SUPABASE_URL` | Yes | Supabase project URL |
| `SUPABASE_ANON_KEY` | Yes | Supabase anonymous key (for auth validation) |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes | Service role key (for DB writes) |
| `VUDY_BASE_URL` | Yes | Vudy API base URL |
| `VUDY_API_KEY` | Yes | Vudy API authentication key |

---

## Security Features

- JWT verification via Supabase Auth
- Service role key used only for DB operations (not exposed to client)
- Idempotency prevents double-spend attacks
- Market status check prevents predictions on closed markets
